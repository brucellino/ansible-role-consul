{{ with secret "pki_hah_int/issue/hah_int_role" "common_name=[[ ansible_hostname ]].node.[[ data_centre ]].consul" "ttl=24h" "alt_names=[[ ansible_hostname ]].station, [[ ansible_hostname ]].node.consul,[[ ansible_hostname ]].hashiatho.me, [[ ansible_hostname ]].brucellino.github.beta.tailscale.net" }}
{{ .Data.certificate | writeToFile "[[ consul_data_dir ]]/agent-certs/[[ data_centre ]]-consul-agent-[[ ansible_hostname ]].pem" "consul" "consul" "0644" }}
{{ .Data.private_key | writeToFile "[[ consul_data_dir ]]/agent-certs/[[ data_centre ]]-consul-agent-[[ ansible_hostname ]]-key.pem" "consul" "consul" "0400" }}
{{ .Data.issuing_ca | writeToFile "[[ consul_data_dir ]]/agent-certs/consul-agent-ca.pem" "consul" "consul" "0644" }}
{{ end }}

datacenter = "[[ data_centre ]]"
data_dir = "[[ consul_data_dir ]]"

{{ with secret "hashiatho.me-v2/consul" }}
encrypt = "{{ .Data.data.gossip_key }}"
{{ end }}

# Logging
## Logging is defined at directory level
log_file = "[[ consul_log_dir ]]"
log_rotate_duration = "[[ consul_log_rotate_duration ]]"
log_rotate_bytes = "[[ consul_log_rotate_bytes ]]"
log_rotate_max_files = [[ consul_log_rotate_max_files ]]

ca_file = "[[ consul_data_dir ]]/agent-certs/consul-agent-ca.pem"
cert_file = "[[ consul_data_dir ]]/agent-certs/[[ data_centre ]]-consul-agent-[[ ansible_hostname ]].pem"
key_file = "[[ consul_data_dir ]]/agent-certs/[[ data_centre ]]-consul-agent-[[ ansible_hostname ]].pem"

verify_incoming = [[ verify_incoming ]]
verify_outgoing = [[ verify_outgoing ]]
verify_server_hostname = [[ verify_server_hostname ]]

recursors = [{%- for s in recursor_dns -%}"[[ s ]]"{%- if not loop.last -%},{% endif %}{% endfor %}]
retry_join = [{%- for s in server_ips -%}"[[ s ]]"{%- if not loop.last -%},{% endif %}{% endfor %}]

# Enable Consul ACLs
acl = {
  enabled = true
  default_policy = "allow"
  enable_token_persistence = true
}
